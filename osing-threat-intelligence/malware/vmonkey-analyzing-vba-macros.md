# vmonkey analyzing VBA macros

Malware infection via malicious macros (or scripts within Microsoft Office products such as Word and Excel) are some of the most successful attacks to date.

For example, current APT campaigns such as Emotet, QuickBot infect users by sending seemingly legitimate documents attached to emails i.e. an invoice for business. However, once opened, execute malicious code without the user knowing. This malicious code is often used in what's known as a "dropper attack", where additional malicious programs are downloaded onto the host.

Take the document file below as an example:\


![](https://i.imgur.com/ciosaCD.png)\


Looks perfectly okay, right? Well in actual fact, this word document has just downloaded a ransomware file from a malicious IP address in the background, with not much more than this snippet of code:\


![](https://i.imgur.com/DQxSeHt.png)\


I have programmed the script to show a pop-up for demonstration purposes. However, in real life, this would be done without any popup.

![](https://i.imgur.com/SVT0kOZ.png)\


Luckily for me, this EXE is safe. Unfortunately in the real-world, this EXE could start encrypting my files.&#x20;

Thankfully Anti-Viruses these days are pretty reliable on picking up that sort of activity when it is left in plaintext. The following example uses two-stages to execute an obfuscated payload code.

1. The macro starts once edit permissions ("Enable Edit" or "Enable Content")have enabled edit mode on the Word document
2. The macro executes the payload stored in the text within the document.

The downside to this? You need a large amount of text to be contained within the page, users will be suspicious and not proceed with editing the document.

![](https://i.imgur.com/5Td2ywE.png)\


Although, just put on your steganography hat...Authors can just remove the borders from the text box and make the text white. The macro doesn't need the text to be visible to the user, it just needs to exist on the page.

![](https://i.imgur.com/DMhsuTd.png)\


See? Not so suspicious now.

Practical

First, we will analyse a suspicious Microsoft Office Word document together. We can simply use REMnux's `vmonkey` which is a parser engine that is capable of analysing visual basic macros without executing (opening the document).

By using `vmonkey DefinitelyALegitInvoice.doc`. `vmonkey` has detected potentially malicious visual basic code within a macro.

![](https://i.imgur.com/jooSji9.png)\


Now it's your turn, analyse the two Microsoft Office document's (.doc) files located within "/home/remnux/Tasks/4" to answer the questions attached to this task.
